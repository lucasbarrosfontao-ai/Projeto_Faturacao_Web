@page "/arquivo"
@using Microsoft.EntityFrameworkCore
@using ProjetoFaturacao.Models
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@using ProjetoFaturacao.Services
@inject UserSession UserSession 

<PageTitle>Arquivo - Recuperar Dados</PageTitle>
@if (!UserSession.IsLoggedIn)
{
    <div class="d-flex justify-content-center align-items-center vh-100">
        <div class="text-center">
            <h3>Acesso Negado</h3>
            <p>Você precisa fazer login para acessar este painel.</p>
            <button class="btn btn-primary" @onclick='() => Navigation.NavigateTo("/login")'>Ir para Login</button>
        </div>
    </div>
}
else 
{
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-archive"></i> Arquivo de Registos</h1>
        <button class="btn btn-outline-secondary" @onclick="Voltar">
            <i class="bi bi-arrow-left"></i> Voltar
        </button>
    </div>

    @* Separadores (Tabs) *@
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "clientes" ? "active" : "")" @onclick='() => SetTab("clientes")'>Clientes</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "fornecedores" ? "active" : "")" @onclick='() => SetTab("fornecedores")'>Fornecedores</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "produtos" ? "active" : "")" @onclick='() => SetTab("produtos")'>Produtos</button>
        </li>
    </ul>

    <div class="tab-content border-start border-end border-bottom p-4 bg-white shadow-sm">
        @if (isLoading)
        {
            <div class="text-center">
                <div class="spinner-border" role="status"></div>
                <p>A carregar arquivo...</p>
            </div>
        }
        else
        {
            @if (activeTab == "clientes")
            {
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Nome</th>
                            <th>NIF</th>
                            <th>Localidade</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var c in clientesInativos)
                        {
                            <tr>
                                <td>@c.Nome</td>
                                <td>@c.NIF</td>
                                <td>@c.Localidade</td>
                                <td>
                                    <button class="btn btn-sm btn-success" @onclick="() => ReativarCliente(c)">
                                        <i class="bi bi-arrow-counterclockwise"></i> Reativar
                                    </button>
                                </td>
                            </tr>
                        }
                        @if (!clientesInativos.Any()) { <tr><td colspan="4" class="text-center text-muted">Nenhum cliente no arquivo.</td></tr> }
                    </tbody>
                </table>
            }
            else if (activeTab == "fornecedores")
            {
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Empresa</th>
                            <th>NIPC</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var f in fornecedoresInativos)
                        {
                            <tr>
                                <td>@f.Nome_Empresa</td>
                                <td>@f.NIPC</td>
                                <td>
                                    <button class="btn btn-sm btn-success" @onclick="() => ReativarFornecedor(f)">
                                        <i class="bi bi-arrow-counterclockwise"></i> Reativar
                                    </button>
                                </td>
                            </tr>
                        }
                        @if (!fornecedoresInativos.Any()) { <tr><td colspan="3" class="text-center text-muted">Nenhum fornecedor no arquivo.</td></tr> }
                    </tbody>
                </table>
            }
            else if (activeTab == "produtos")
            {
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Referência</th>
                            <th>Nome</th>
                            <th>Preço Venda</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in produtosInativos)
                        {
                            <tr>
                                <td>@p.Referencia</td>
                                <td>@p.Nome</td>
                                <td>@p.Preco_Venda.ToString("C")</td>
                                <td>
                                    <button class="btn btn-sm btn-success" @onclick="() => ReativarProduto(p)">
                                        <i class="bi bi-arrow-counterclockwise"></i> Reativar
                                    </button>
                                </td>
                            </tr>
                        }
                        @if (!produtosInativos.Any()) { <tr><td colspan="4" class="text-center text-muted">Nenhum produto no arquivo.</td></tr> }
                    </tbody>
                </table>
            }
        }
    </div>
</div>
}
@code {
    private string activeTab = "clientes";
    private bool isLoading = true;

    private List<Cliente> clientesInativos = new();
    private List<Fornecedor> fornecedoresInativos = new();
    private List<Produto> produtosInativos = new();

    protected override async Task OnInitializedAsync()
    {
        await CarregarDados();
    }

    private async Task CarregarDados()
    {
        if (!UserSession.IsLoggedIn)
        {
            // Se não estiver logado, redireciona imediatamente
            Navigation.NavigateTo("/login");
            return;
        }
        isLoading = true;
        clientesInativos = await DbContext.Clientes.Where(c => !c.Ativo).ToListAsync();
        fornecedoresInativos = await DbContext.Fornecedores.Where(f => !f.Ativo).ToListAsync();
        produtosInativos = await DbContext.Produtos.Where(p => !p.Ativo).ToListAsync();
        isLoading = false;
    }

    private void SetTab(string tab) => activeTab = tab;

    private async Task ReativarCliente(Cliente c)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Reativar o cliente {c.Nome}?");
        if (confirmed)
        {
            c.Ativo = true;
            DbContext.Clientes.Update(c);
            await DbContext.SaveChangesAsync();
            await CarregarDados();
        }
    }

    private async Task ReativarFornecedor(Fornecedor f)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Reativar o fornecedor {f.Nome_Empresa}?");
        if (confirmed)
        {
            f.Ativo = true;
            DbContext.Fornecedores.Update(f);
            await DbContext.SaveChangesAsync();
            await CarregarDados();
        }
    }

    private async Task ReativarProduto(Produto p)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Reativar o produto {p.Nome}?");
        if (confirmed)
        {
            p.Ativo = true;
            DbContext.Produtos.Update(p);
            await DbContext.SaveChangesAsync();
            await CarregarDados();
        }
    }

    private void Voltar() => Navigation.NavigateTo("/");
}